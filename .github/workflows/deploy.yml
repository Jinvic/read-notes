# .github/workflows/deploy.yml
name: Deploy Site

on:
  workflow_dispatch:
  # å½“srcç›®å½•æˆ–ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶è§¦å‘
  push:
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'mkdocs.yml'
      - 'README.md'
    branches: [ main, master ]

# å¹¶å‘æ§åˆ¶
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: è®°å½•å¼€å§‹æ—¶é—´
        run: |
          echo "ğŸ• éƒ¨ç½²ä»»åŠ¡å¼€å§‹: $(date)"
        
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install mkdocs mkdocs-material
          
      - name: æ£€æŸ¥srcç›®å½•
        id: check-src
        run: |
          echo "ğŸ“ æ£€æŸ¥srcç›®å½•..."
          
          if [ ! -d "src" ]; then
            echo "âŒ srcç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          MD_COUNT=$(find src -name "*.md" -type f | wc -l)
          if [ $MD_COUNT -eq 0 ]; then
            echo "âš ï¸  srcç›®å½•ä¸­æ²¡æœ‰Markdownæ–‡ä»¶"
          else
            echo "âœ… srcç›®å½•ä¸­æœ‰ $MD_COUNT ä¸ªMarkdownæ–‡ä»¶"
            echo "md_count=$MD_COUNT" >> $GITHUB_OUTPUT
          fi
          
      - name: åˆ›å»ºdocsç›®å½•ç»“æ„
        run: |
          echo "ğŸ“ åˆ›å»ºdocsç›®å½•ç»“æ„..."
          
          # æ¸…ç†æ—§çš„docsç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          rm -rf docs
          mkdir -p docs
          
          # åˆ›å»ºå¿…è¦çš„å­ç›®å½•
          mkdir -p docs/reading-notes
          mkdir -p docs/assets/images
          
      - name: è½¬æ¢Hugoæ ¼å¼ä¸ºMkDocsæ ¼å¼
        if: steps.check-src.outputs.md_count != '0'
        run: |
          echo "ğŸ”„ è½¬æ¢ç¬”è®°æ ¼å¼..."
          
          python scripts/hugo_to_mkdocs.py \
            --src-dir ./src \
            --output-dir ./docs/reading-notes \
            --image-base ../assets/images \
            --log-level INFO
          
          echo "âœ… ç¬”è®°è½¬æ¢å®Œæˆ"
          
      - name: å¤åˆ¶å›¾ç‰‡åˆ°docsç›®å½•
        run: |
          echo "ğŸ–¼ï¸  å¤åˆ¶å›¾ç‰‡..."
          
          if [ -d "src/images" ]; then
            echo "ä»src/images/å¤åˆ¶åˆ°docs/assets/images/"
            cp -r src/images/* docs/assets/images/ 2>/dev/null || true
            IMAGE_COUNT=$(find docs/assets/images -type f | wc -l)
            echo "âœ… å¤åˆ¶äº† $IMAGE_COUNT ä¸ªå›¾ç‰‡æ–‡ä»¶"
          else
            echo "âš ï¸  src/imagesç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å›¾ç‰‡å¤åˆ¶"
          fi
          
      - name: å¤åˆ¶READMEåˆ°docsç›®å½•
        run: |
          echo "ğŸ“„ å¤åˆ¶README..."
          
          if [ -f "README.md" ]; then
            cp README.md docs/
            echo "âœ… READMEå·²å¤åˆ¶"
          else
            echo "âš ï¸  README.mdä¸å­˜åœ¨"
          fi
          
      - name: éªŒè¯docsç›®å½•ç»“æ„
        run: |
          echo "ğŸ“‚ éªŒè¯docsç›®å½•ç»“æ„..."
          echo "å½“å‰ç›®å½•ç»“æ„:"
          find docs -type f | head -20
          
          # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
          if [ -f "docs/index.md" ]; then
            echo "âœ… é¦–é¡µå­˜åœ¨: docs/index.md"
          else
            echo "âŒ é¦–é¡µä¸å­˜åœ¨"
          fi
          
          if [ -f "mkdocs.yml" ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨: mkdocs.yml"
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: æ„å»ºé™æ€ç½‘ç«™
        run: |
          echo "ğŸ—ï¸  æ„å»ºMkDocsç«™ç‚¹..."
          mkdocs build --verbose --strict
          echo "âœ… æ„å»ºå®Œæˆ"
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -d "site" ]; then
            SITE_SIZE=$(du -sh site | cut -f1)
            echo "ç«™ç‚¹å¤§å°: $SITE_SIZE"
            echo "ç«™ç‚¹å†…å®¹:"
            find site -type f | head -10
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œsiteç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: easingthemes/ssh-deploy@v5.1.0
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rlgoDzvc --delete"
          SOURCE: ./site/
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: ${{ secrets.REMOTE_TARGET }}
          SCRIPT_BEFORE: |
            echo "ğŸ”§ å¼€å§‹éƒ¨ç½²..."
            echo "æ—¶é—´: $(date)"
            echo "æ¥æºæäº¤: ${{ github.sha }}"
          SCRIPT_AFTER: |
            echo "âœ… éƒ¨ç½²å®Œæˆ"
            echo "æ—¶é—´: $(date)"
            echo "éƒ¨ç½²å®Œæˆ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf docs site
          
      - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š éƒ¨ç½²ä»»åŠ¡æŠ¥å‘Š"
          echo "================"
          echo "ä»»åŠ¡çŠ¶æ€: ${{ job.status }}"
          echo "è§¦å‘æäº¤: ${{ github.sha }}"
          echo "æºæ–‡ä»¶æ•°: ${{ steps.check-src.outputs.md_count || 0 }}"
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo ""
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
            echo "ç½‘ç«™å·²æ›´æ–°åˆ°æœ€æ–°å†…å®¹"
          else
            echo ""
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            echo "è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
          fi