# .github/workflows/convert.yml
name: Convert Notes

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“srcç›®å½•æœ‰å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘
  push:
    paths:
      - 'src/**'
      - 'scripts/hugo_to_mkdocs.py'
    branches: [ main, master ]

# å¹¶å‘æ§åˆ¶
concurrency:
  group: convert-${{ github.ref }}
  cancel-in-progress: true

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # å¢åŠ è¶…æ—¶æ—¶é—´
    
    steps:
      - name: è®°å½•å¼€å§‹æ—¶é—´
        run: echo "ğŸ• è½¬æ¢ä»»åŠ¡å¼€å§‹: $(date)"
        
      - name: æ£€å‡ºä»£ç ï¼ˆä½¿ç”¨PATï¼‰
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨PATä»¥ä¾¿æ¨é€
          fetch-depth: 0
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install frontmatter markdown
          
      - name: æ£€æŸ¥srcç›®å½•
        id: check-src
        run: |
          echo "ğŸ“ æ£€æŸ¥srcç›®å½•å†…å®¹..."
          
          if [ ! -d "src" ]; then
            echo "âŒ srcç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç»Ÿè®¡æ–‡ä»¶
          MD_COUNT=$(find src -name "*.md" -type f | wc -l)
          IMAGE_COUNT=$(find src -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" -o -name "*.webp" -o -name "*.bmp" | wc -l)
          META_COUNT=$(find src -name "*.meta.json" -type f | wc -l)
          
          echo "ğŸ“Š srcç›®å½•ç»Ÿè®¡:"
          echo "  Markdownæ–‡ä»¶: $MD_COUNT ä¸ª"
          echo "  å›¾ç‰‡æ–‡ä»¶: $IMAGE_COUNT ä¸ª"
          echo "  å…ƒæ•°æ®æ–‡ä»¶: $META_COUNT ä¸ª"
          
          if [ $MD_COUNT -eq 0 ]; then
            echo "âŒ srcç›®å½•ä¸­æ²¡æœ‰Markdownæ–‡ä»¶"
            exit 1
          fi
          
          # è¾“å‡ºå˜é‡
          echo "md_count=$MD_COUNT" >> $GITHUB_OUTPUT
          echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
          echo ""
          echo "ğŸ“„ å¾…è½¬æ¢çš„Markdownæ–‡ä»¶:"
          find src -name "*.md" -type f | while read f; do
            size=$(stat -f%z "$f" 2>/dev/null || stat -c%s "$f" 2>/dev/null || echo "?")
            name=$(basename "$f")
            echo "  - $name ($size bytes)"
          done
          
      - name: å¤åˆ¶å›¾ç‰‡åˆ°docsç›®å½•
        run: |
          echo "ğŸ–¼ï¸  å¤åˆ¶å›¾ç‰‡åˆ°docsç›®å½•..."
          
          # åˆ›å»ºå›¾ç‰‡ç›®å½•
          mkdir -p docs/assets/images
          
          # å¦‚æœsrc/imageså­˜åœ¨ï¼Œå¤åˆ¶åˆ°docs/assets/images
          if [ -d "src/images" ]; then
            echo "å¤åˆ¶src/images/åˆ°docs/assets/images/"
            # ä½¿ç”¨rsyncä¿æŒç›®å½•ç»“æ„ï¼Œå…è®¸è¦†ç›–
            if command -v rsync >/dev/null 2>&1; then
              rsync -av --ignore-existing src/images/ docs/assets/images/
            else
              cp -r src/images/* docs/assets/images/ 2>/dev/null || true
            fi
            
            echo "âœ… å›¾ç‰‡å¤åˆ¶å®Œæˆ"
            echo "docs/assets/imagesç›®å½•å†…å®¹:"
            find docs/assets/images -type f | head -10
          else
            echo "âš ï¸  src/imagesç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å›¾ç‰‡å¤åˆ¶"
          fi
          
      - name: è½¬æ¢ä¸ºMkDocsæ ¼å¼
        id: convert-step
        run: |
          echo "ğŸ”„ å¼€å§‹è½¬æ¢æ ¼å¼..."
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p docs/reading-notes
          
          # è¿è¡Œè½¬æ¢è„šæœ¬
          python scripts/hugo_to_mkdocs.py \
            --src-dir ./src \
            --output-dir ./docs/reading-notes \
            --image-base /assets/images \
            --log-level INFO
          
          echo "âœ… æ ¼å¼è½¬æ¢å®Œæˆ"
          
          # æ˜¾ç¤ºè½¬æ¢ç»“æœ
          echo "ğŸ“‚ è½¬æ¢ç»“æœç›®å½•ç»“æ„:"
          if command -v tree &> /dev/null; then
            tree docs/reading-notes --dirsfirst -L 3 || echo "treeå‘½ä»¤ä¸å¯ç”¨"
          else
            find docs/reading-notes -type f | head -20
          fi
          
          # ç»Ÿè®¡è½¬æ¢ç»“æœ
          OUTPUT_COUNT=$(find docs/reading-notes -name "*.md" -type f | wc -l)
          echo "ğŸ“„ ç”ŸæˆMarkdownæ–‡ä»¶: $OUTPUT_COUNT ä¸ª"
          echo "output_count=$OUTPUT_COUNT" >> $GITHUB_OUTPUT
          
      - name: ç”Ÿæˆå¯¼èˆªé…ç½®
        run: |
          echo "ğŸ“‹ ç”Ÿæˆå¯¼èˆªé…ç½®..."
          
          # ä¸´æ—¶å¯¼èˆªé…ç½®
          cat > docs/reading-notes/README.md << 'EOF'
          # è¯»ä¹¦ç¬”è®°

          è¿™é‡Œæ˜¯ä»HugoåŒæ­¥è¿‡æ¥çš„è¯»ä¹¦ç¬”è®°ï¼ŒæŒ‰ä¹¦ç±åˆ†ç±»ã€‚

          EOF
          
          echo "å¯¼èˆªå ä½æ–‡ä»¶å·²åˆ›å»º"
          
      - name: æäº¤è½¬æ¢ç»“æœ
        id: commit-step
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "ğŸ“ æäº¤è½¬æ¢ç»“æœ..."
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # æ·»åŠ docsç›®å½•å˜æ›´
          git add docs/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if git diff --cached --quiet; then
            echo "â„¹ï¸  docsç›®å½•æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            # æŸ¥çœ‹å˜æ›´å†…å®¹
            echo "ğŸ“‹ å˜æ›´å†…å®¹é¢„è§ˆ:"
            git diff --cached --name-status | head -20
            
            # æäº¤å˜æ›´
            git commit -m "docs: è½¬æ¢ç¬”è®°æ ¼å¼ [auto]
            
              åŸå§‹Markdownæ–‡ä»¶: ${{ steps.check-src.outputs.md_count }}
              ç”Ÿæˆæ–‡ä»¶: ${{ steps.convert-step.outputs.output_count }}
              å›¾ç‰‡æ–‡ä»¶: ${{ steps.check-src.outputs.image_count }}"
            
            # é…ç½®è¿œç¨‹ä»“åº“ä½¿ç”¨PAT
            git remote set-url origin https://x-access-token:$PAT_TOKEN@github.com/${{ github.repository }}.git
            
            # æ¨é€å˜æ›´
            echo "ğŸš€ æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
            git push origin ${{ github.ref_name }}
            
            echo "âœ… å·²æäº¤å¹¶æ¨é€è½¬æ¢ç»“æœ"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi
          
      - name: ç”Ÿæˆè½¬æ¢æŠ¥å‘Š
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š è½¬æ¢ä»»åŠ¡æŠ¥å‘Š"
          echo "================"
          echo "ä»»åŠ¡çŠ¶æ€: ${{ job.status }}"
          echo "åŸå§‹æ–‡ä»¶: ${{ steps.check-src.outputs.md_count }} ä¸ªMarkdown"
          echo "åŸå§‹å›¾ç‰‡: ${{ steps.check-src.outputs.image_count }} ä¸ª"
          echo "ç”Ÿæˆæ–‡ä»¶: ${{ steps.convert-step.outputs.output_count || 0 }} ä¸ª"
          echo "æ˜¯å¦æäº¤: ${{ steps.commit-step.outputs.has_changes || 'false' }}"
          
          if [[ "${{ job.status }}" == "success" ]]; then
            if [[ "${{ steps.commit-step.outputs.has_changes }}" == "true" ]]; then
              echo ""
              echo "ğŸ‰ è½¬æ¢æˆåŠŸå¹¶å·²æäº¤!"
              echo "è½¬æ¢åçš„æ–‡ä»¶åœ¨: docs/reading-notes/"
            else
              echo ""
              echo "â„¹ï¸  è½¬æ¢å®Œæˆï¼Œä½†æœªæ£€æµ‹åˆ°å˜æ›´ï¼ˆå¯èƒ½å·²ç»æ˜¯æœ€æ–°ï¼‰"
            fi
          else
            echo ""
            echo "âŒ è½¬æ¢ä»»åŠ¡å¤±è´¥"
          fi