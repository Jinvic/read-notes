# .github/workflows/convert.yml
name: Convert Notes

on:
  push:
    paths:
      - 'src/**'
      - 'scripts/**'
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: convert-${{ github.ref }}
  cancel-in-progress: true

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: æ£€æŸ¥srcç›®å½•
        run: |
          echo "ğŸ“ æ£€æŸ¥srcç›®å½•..."
          if [ ! -d "src" ] || [ -z "$(ls -A src 2>/dev/null)" ]; then
            echo "âŒ srcç›®å½•ä¸ºç©º"
            exit 1
          fi
          echo "âœ… srcç›®å½•å­˜åœ¨ï¼Œå¼€å§‹è½¬æ¢"
          
      - name: è½¬æ¢Hugoæ ¼å¼ä¸ºMkDocsæ ¼å¼
        run: |
          echo "ğŸ”„ è¿è¡Œè½¬æ¢è„šæœ¬..."
          python scripts/hugo_to_mkdocs.py \
            --src-dir ./src \
            --output-dir ./docs/reading-notes \
            --image-base ../assets/images \
            --log-level INFO
          
      - name: å¤åˆ¶README
        run: |
          echo "ğŸ“„ å¤åˆ¶README..."
          python scripts/copy_readme.py
          
      - name: æäº¤è½¬æ¢ç»“æœ
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "ğŸ“ æäº¤å˜æ›´..."
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # æ·»åŠ docsç›®å½•å˜æ›´
          git add docs/
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "docs: æ›´æ–°è½¬æ¢åçš„ç¬”è®° [auto]"
            git remote set-url origin https://x-access-token:$PAT_TOKEN@github.com/${{ github.repository }}.git
            git push origin ${{ github.ref_name }}
            echo "âœ… å·²æäº¤å¹¶æ¨é€"
          fi
          
      - name: ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“Š è½¬æ¢ä»»åŠ¡å®Œæˆ"
          echo "çŠ¶æ€: ${{ job.status }}"