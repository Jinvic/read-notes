# .github/workflows/convert.yml
name: Convert Notes

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æˆ–è€…å½“srcç›®å½•æœ‰å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘
  push:
    paths:
      - 'src/**'
      - 'scripts/hugo_to_mkdocs.py'
  # æˆ–è€…ç”±sync-onlyå·¥ä½œæµè§¦å‘
  # repository_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install frontmatter
          
      - name: æ£€æŸ¥srcç›®å½•
        run: |
          echo "ğŸ“ æ£€æŸ¥srcç›®å½•å†…å®¹..."
          if [ ! -d "src" ] || [ -z "$(ls -A src 2>/dev/null)" ]; then
            echo "âŒ srcç›®å½•ä¸ºç©ºï¼Œæ²¡æœ‰å¯è½¬æ¢çš„å†…å®¹"
            exit 1
          fi
          
          echo "æ‰¾åˆ°ä»¥ä¸‹Markdownæ–‡ä»¶:"
          find src -name "*.md" -type f | while read f; do
            echo "  - $f"
          done
          
      - name: è½¬æ¢ä¸ºMkDocsæ ¼å¼
        run: |
          echo "ğŸ”„ å¼€å§‹è½¬æ¢æ ¼å¼..."
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p docs/reading-notes
          
          # è¿è¡Œè½¬æ¢è„šæœ¬
          python scripts/hugo_to_mkdocs.py \
            --src-dir ./src \
            --output-dir ./docs/reading-notes \
            --image-base /assets/images \
            --log-level INFO
          
          echo "âœ… æ ¼å¼è½¬æ¢å®Œæˆ"
          
          # æ˜¾ç¤ºè½¬æ¢ç»“æœ
          echo "è½¬æ¢ç»“æœ:"
          find docs/reading-notes -name "*.md" -type f | head -10
          
      - name: ç”Ÿæˆå¯¼èˆªé…ç½®
        run: |
          echo "ğŸ“‹ ç”Ÿæˆå¯¼èˆªé…ç½®..."
          
          # è¿™é‡Œå¯ä»¥è°ƒç”¨ç”Ÿæˆå¯¼èˆªçš„è„šæœ¬
          # python scripts/generate_nav.py
          
          echo "å¯¼èˆªé…ç½®ç”Ÿæˆå®Œæˆ"
          
      - name: æäº¤è½¬æ¢ç»“æœ
        run: |
          echo "ğŸ“ æäº¤è½¬æ¢ç»“æœ..."
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # æ·»åŠ docsç›®å½•å˜æ›´
          git add docs/
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸  docsç›®å½•æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "docs: æ›´æ–°è½¬æ¢åçš„ç¬”è®° [auto]"
            git push origin ${{ github.ref_name }}
            echo "âœ… å·²æäº¤å¹¶æ¨é€è½¬æ¢ç»“æœ"
          fi