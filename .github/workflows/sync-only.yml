# .github/workflows/sync-only.yml
name: Sync Only (from Hugo)

on:
  workflow_dispatch:
    inputs:
      hugo_repo:
        description: 'Hugoä»“åº“åç§°'
        required: true
      hugo_commit:
        description: 'Hugoæäº¤å“ˆå¸Œ'
        required: true
      sync_reason:
        description: 'åŒæ­¥åŸå› '
        required: true
      notes_json:
        description: 'éœ€è¦åŒæ­¥çš„ç¬”è®°é…ç½®(JSON)'
        required: true

# å¹¶å‘æ§åˆ¶
concurrency:
  group: sync-only-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-notes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: è®°å½•è§¦å‘ä¿¡æ¯
        run: |
          echo "ğŸ”„ åŒæ­¥ä»»åŠ¡å¼€å§‹"
          echo "æ¥æº: ${{ github.event.inputs.hugo_repo }}"
          echo "æäº¤: ${{ github.event.inputs.hugo_commit }}"
          echo "åŸå› : ${{ github.event.inputs.sync_reason }}"
          
      - name: æ£€å‡ºMkDocsä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.HUGO_TOKEN }}
          fetch-depth: 0
          
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyyaml frontmatter
          
      - name: è§£æåŒæ­¥é…ç½®
        id: parse-config
        run: |
          # å°†è¾“å…¥çš„JSONä¿å­˜åˆ°æ–‡ä»¶
          echo '${{ github.event.inputs.notes_json }}' > sync-notes.json
          
          # ç»Ÿè®¡ç¬”è®°æ•°é‡
          NOTE_COUNT=$(python -c "import json; data=json.load(open('sync-notes.json')); print(len(data))")
          echo "ğŸ“š éœ€è¦åŒæ­¥ $NOTE_COUNT ç¯‡ç¬”è®°"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "note_count=$NOTE_COUNT" >> $GITHUB_OUTPUT
          
      - name: ä»Hugoä»“åº“æ‹‰å–å†…å®¹
        env:
          HUGO_TOKEN: ${{ secrets.HUGO_TOKEN }}
        run: |
          echo "â¬‡ï¸  æ­£åœ¨ä»Hugoä»“åº“æ‹‰å–å†…å®¹..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p hugo-temp
          
          # å…‹éš†Hugoä»“åº“ï¼ˆæœ€å°åŒ–å…‹éš†ï¼‰
          git clone \
            --depth 1 \
            --no-checkout \
            --filter=blob:none \
            "https://x-access-token:$HUGO_TOKEN@github.com/${{ github.event.inputs.hugo_repo }}" \
            hugo-temp
          
          cd hugo-temp
          
          # æ£€å‡ºæŒ‡å®šæäº¤
          git checkout ${{ github.event.inputs.hugo_commit }}
          
          echo "âœ… Hugoä»“åº“å†…å®¹å·²æ‹‰å–"
          echo "æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"
          
      - name: åŒæ­¥ç¬”è®°å’Œå›¾ç‰‡åˆ°srcç›®å½•
        id: sync-step
        run: |
          echo "ğŸ”„ å¼€å§‹åŒæ­¥ç¬”è®°å’Œå›¾ç‰‡..."
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p src
          
          # è¿è¡ŒåŒæ­¥è„šæœ¬ï¼ˆåªåŒæ­¥åˆ°srcç›®å½•ï¼Œä¸è½¬æ¢ï¼‰
          python scripts/sync_from_hugo.py \
            --hugo-dir ./hugo-temp \
            --config sync-notes.json \
            --src-dir ./src \
            --skip-conversion \
            --log-level INFO
          
          # æ£€æŸ¥åŒæ­¥ç»“æœ
          if [ -d "src" ] && [ "$(ls -A src 2>/dev/null)" ]; then
            echo "âœ… åŒæ­¥å®Œæˆï¼Œsrcç›®å½•å†…å®¹:"
            find src -type f -name "*.md" | head -10
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  åŒæ­¥å®Œæˆï¼Œä½†srcç›®å½•ä¸ºç©º"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
      - name: æäº¤åŒæ­¥ç»“æœ
        if: steps.sync-step.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“ æäº¤åŒæ­¥ç»“æœåˆ°Git..."
          
          # é…ç½®Gitç”¨æˆ·
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add src/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if git diff --cached --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰å®é™…å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "has_actual_changes=false" >> $GITHUB_OUTPUT
          else
            # æäº¤å˜æ›´
            git commit -m "sync: ä»HugoåŒæ­¥ç¬”è®° [${{ github.event.inputs.hugo_commit }}]
            
            æ¥æº: ${{ github.event.inputs.hugo_repo }}
            åŸå› : ${{ github.event.inputs.sync_reason }}
            ç¬”è®°æ•°: ${{ steps.parse-config.outputs.note_count }}"
            
            # æ¨é€å˜æ›´
            git push origin ${{ github.ref_name }}
            
            echo "âœ… å·²æäº¤å¹¶æ¨é€åŒæ­¥ç»“æœ"
            echo "has_actual_changes=true" >> $GITHUB_OUTPUT
            echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi
          
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf hugo-temp sync-notes.json
          
      - name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“Š åŒæ­¥ä»»åŠ¡æŠ¥å‘Š"
          echo "================"
          echo "ä»»åŠ¡çŠ¶æ€: ${{ job.status }}"
          echo "è§¦å‘æ¥æº: ${{ github.event.inputs.hugo_repo }}"
          echo "åŒæ­¥åŸå› : ${{ github.event.inputs.sync_reason }}"
          echo "ç¬”è®°æ•°é‡: ${{ steps.parse-config.outputs.note_count }}"
          echo "åŒæ­¥å˜æ›´: ${{ steps.sync-step.outputs.has_changes || 'false' }}"
          echo "å®é™…æäº¤: ${{ steps.sync-step.outputs.has_actual_changes || 'false' }}"
          if [[ "${{ steps.sync-step.outputs.commit_hash }}" != "" ]]; then
            echo "æäº¤å“ˆå¸Œ: ${{ steps.sync-step.outputs.commit_hash }}"
          fi
          
      - name: è§¦å‘è½¬æ¢å·¥ä½œæµï¼ˆå¯é€‰ï¼‰
        if: steps.sync-step.outputs.has_actual_changes == 'true'
        run: |
          echo "ğŸš€ åŒæ­¥å®Œæˆï¼Œå‡†å¤‡è§¦å‘è½¬æ¢å·¥ä½œæµ..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ è§¦å‘convert.ymlå·¥ä½œæµçš„ä»£ç 
          # æˆ–è€…ç­‰æ‰‹åŠ¨è§¦å‘